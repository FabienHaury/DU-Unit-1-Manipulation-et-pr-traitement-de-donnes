---
title: "Analyse d'un jeu de données réel"
author: "Fabien Haury"
date: "2022-04-12"
output:
  html_document:
    toc: true
    toc_depth: '2'
    df_print: paged
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    fig_width: 8
    fig_height: 7
    keep_md: true
    df_print: tibble
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align = "center")
```

# Librairies

```{r library, message=FALSE, warning=FALSE}

library(plyr)
library(tidyverse)
library(lubridate)
library(naniar)
library(scales)
library(ggsci)
library(GGally)
library(ggthemes)
library(lemon)
library(rvest)

```

`plyr` pour appliquer le paradigme «split-apply-combine».\
`tidyverse` contient tidyr, dplyr et ggplot2 pour la manipulation et visualisation des données.\
`naniar` pour visualiser les données manquantes.\
`lubridate` pour la gestion des formats de date.\
`scales` pour modifier les formats d'échelles des graphiques.\
`ggsci` pour différents thèmes de graphique.\
`ggthemes` donne accès à des thèmes supplémentaires pour `ggplot2`\
`lemon` donne accès à des fonction suppémentaires pour changer subtilement des aspects de `ggplot2`\
`rvest` pour le web scraping.

# Données manquantes

## Jeu de données PhD_v1

### Import du jeu de données

```{r PhD_v1, message = FALSE, warning = FALSE}

these_v1 <- read_csv("jeux_de_donnees/PhD_v1.csv")
head(these_v1)
dim(these_v1)
rm(these_v1)

```

La commande `rm` permet de supprimer la variable `these_v1`\

## Jeu de données PhD_v2

### Import et préparation des données

```{r PhD import preparation, message = FALSE, warning = FALSE}

these <- as_tibble(read_csv("jeux_de_donnees/PhD_v2.csv"))
these$`Date de soutenance` <- dmy(these$`Date de soutenance`)
these$`Publication dans theses.fr` <- dmy(these$`Publication dans theses.fr`)
these$`Mise a jour dans theses.fr` <- dmy(these$`Mise a jour dans theses.fr`)
these$Statut <- as.factor(these$Statut)
these$`Langue de la these` <- as.factor(these$`Langue de la these`)
these$`Accessible en ligne` <- as.factor(these$`Accessible en ligne`)
these$`Identifiant directeur` <- na_if(these$`Identifiant directeur`,"na")

```

### Summary.

```{r PhD summary, message = FALSE, warning = FALSE}

head(these)
glimpse(these)
summary(these)

these %>% 
  summarise(across(everything(), n_distinct)) %>% 
  glimpse()

```

## Visualisation des données manquantes

### Préparation des données manquantes

```{r PhD preparation NA, message=FALSE, warning=FALSE}

these_NA <- these %>% select(Statut, `Date de premiere inscription en doctorat`, 
                                   `Date de soutenance`, Year, `Langue de la these`) 
these_NA_encours <- these_NA %>% filter(Statut == "enCours")
these_NA_soutenue <- these_NA %>% filter(Statut == "soutenue")

```

### Visualisation des données manquantes

```{r PhD visualisation NA, message=FALSE, warning=FALSE}

# Visualisation donnees manquantes
vis_miss(these, warn_large_data = FALSE) +
  scale_y_continuous(labels = comma) +
  theme(axis.text.x =  element_text(angle = 90))

gg_miss_upset(these)

# Visualisation statut enCours
vis_miss(these_NA_encours, warn_large_data = FALSE) +
  scale_y_continuous(labels = comma) +
  theme(axis.text.x =  element_text(angle = 90))
gg_miss_upset(these_NA_encours)

# Visualisation statut soutenue
vis_miss(these_NA_soutenue, warn_large_data = FALSE) +
  scale_y_continuous(labels = comma) +
  theme(axis.text.x =  element_text(angle = 90))
gg_miss_upset(these_NA_soutenue)

```

# Problèmes

## Problèmes soutenances

### Préparations des données

```{r PhD problèmes date soutenance selection, message = FALSE, warning = FALSE}

these_soutenance <- these %>% select(Year, `Date de soutenance`) 
these_soutenance <- these_soutenance %>% 
  mutate(month =  as.factor(month(`Date de soutenance`, label = TRUE)),
         day = as.factor(day(`Date de soutenance`)))

```

Selection des variables cibles et création de nouvelles colonnes `month` et `day` pour plus de lisibilité dans le code suivant.\

### Préparation des tables intermédiaires.

```{r PhD problèmes date soutenance table, message = FALSE, warning = FALSE}

# full_join pour la distribution des pourcentages moyens de soutenance par mois avec errorbar
# Sans filtrer le 1 Janvier
these_soutenance_count_year <- these_soutenance %>% 
  filter(Year > 2004 & Year < 2019) %>% 
  count(Year) %>% 
  rename(total_year = n)

these_soutenance_year_month <-  these_soutenance  %>% 
  filter(Year > 2004 & Year < 2019) %>% 
  count(Year, month) %>% 
  rename(total_month = n)

these_soutenance_full <- full_join(these_soutenance_count_year, 
                                            these_soutenance_year_month, 
                                            by = "Year") %>% 
  mutate(freq = total_month / total_year) %>% 
  drop_na()

# Avec filtre sur le 1 Janvier
these_soutenance_count_year_no_first <- these_soutenance %>% 
  filter(day != "1" & Year > 2004 & Year < 2019) %>% 
  count(Year) %>% 
  rename(total_year = n)

these_soutenance_year_month_no_first <-  these_soutenance  %>% 
  filter(day != "1" & Year > 2004 & Year < 2019) %>% 
  count(Year, month) %>% 
  rename(total_month = n)

these_soutenance_full_no_first <- full_join(these_soutenance_count_year_no_first, 
                                   these_soutenance_year_month_no_first, 
                                   by = "Year") %>% 
  mutate(freq = total_month / total_year) %>% 
  drop_na()

# full_join pour l'evolution des frequences des defenses de theses par annees au premier janvier
these_soutenance_count_year <- these_soutenance %>% 
  count(Year) %>% 
  rename(total_year = n)

these_soutenance_count_janv <- these_soutenance %>% 
  filter(month == "janv" & day == "1") %>% 
  group_by(Year) %>% 
  count(Year) %>% 
  rename(total_janv = n)

these_soutenance_year_janv <- full_join(these_soutenance_count_year, 
                                           these_soutenance_count_janv, by = "Year") %>% 
  mutate(freq = total_janv / total_year)
```

### Visualisations

```{r PhD problèmes date soutenance, message = FALSE, warning = FALSE}

# Distribution du total these par mois
these_soutenance %>%
  filter(Year > 1983 & Year < 2019) %>% 
  count(month) %>% 
  ggplot(aes(month, n)) +
  geom_col(fill = "steelblue", color = "black") +
  scale_y_continuous(labels = comma,
                     breaks = seq(0, 300000, 50000)) +
  labs(x = "\nMois",
       y = "Total thèses soutenues\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 0))

# facet_wrap month~year
these_soutenance %>% 
  filter(Year > 2004 & Year < 2019) %>% 
  count(Year, month) %>%
  ggplot(aes(month, n)) +
  geom_col(fill = "steelblue", color = "black") +
  facet_wrap( ~ Year) +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  labs(x = "\nMois",
       y = "Total thèses soutenues\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 0))

# Distribution des pourcentages moyens de soutenance par mois avec errorbar
# Avec 1 Janvier
these_soutenance_full %>% 
  ddply(~month, summarise, mean = mean(freq, na.rm = TRUE), sd = sd(freq, na.rm = TRUE)) %>% 
  ggplot(aes(month, mean)) +
  geom_col(fill = "steelblue", color = "black") +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
  scale_y_continuous(labels = percent_format()) +
  labs(x = "\nMois",
       y = "Pourcentage de soutenance\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 0))

# Sans 1 Janvier
these_soutenance_full_no_first %>% 
  ddply(~month, summarise, mean = mean(freq, na.rm = TRUE), sd = sd(freq, na.rm = TRUE)) %>% 
  ggplot(aes(month, mean)) +
  geom_col(fill = "steelblue", color = "black") +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd)) +
  scale_y_continuous(labels = percent_format()) +
  labs(x = "\nMois",
       y = "Pourcentage de soutenance\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 0))

# Evolution des frequences des defenses de theses par annees au premier janvier
these_soutenance_year_janv %>% 
  ggplot(aes(Year, freq)) +
  geom_line(color = "steelblue", size = 1) +
  scale_x_continuous(breaks = seq(1970, 2020, 5)) +
  scale_y_continuous(labels = percent_format()) +
  labs(x = "\nAnnée",
       y = "Pourcentage des défenses de thèses\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 0))

```

## Problème homonyme Cecile Martin

### Import et préparation des données

```{r PhD problèmes homonyme import cecile martin, message = FALSE, warning = FALSE}

these_cecile_martin <- these %>% 
  filter(str_detect(Auteur, "Cecile Martin")) %>% 
  slice(-c(4,6, 8, 9, 12))

glimpse(these_cecile_martin %>% 
  summarise(across(everything(), n_distinct)))

```

### Visualisation des données manquantes

```{r PhD problèmes homonyme cecile martin, message=FALSE, warning=FALSE}

these_cecile_martin %>% 
  vis_miss() +
  scale_y_continuous(labels = comma) +
  theme(axis.text.x =  element_text(angle = 90))

```

### Exploration des données

```{r PhD problèmes homonyme exploration cecile martin, message=FALSE, warning=FALSE}

these_cecile_martin %>% 
  ggplot(aes(x = Year)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black") +
  scale_x_continuous(breaks = seq(1985, 2020, 3)) +
  scale_y_continuous(breaks = c(0, 1)) +
  labs(x = "\nAnnée",
       y = "Total thèse\n") +
  theme_stata() +
  theme(axis.text.x =  element_text(angle = 45,
                                    vjust = 0.5),
        axis.text.y = element_text(angle = 0))

# Filtrage sur l'Identifiant auteur "81323557"
these_cecile_martin %>% 
  filter(`Identifiant auteur` == "81323557") %>% 
  ggplot(aes(x = Year)) +
  geom_bar(binwidth = 1, fill = "steelblue", color = "black") +
  scale_x_continuous(breaks = seq(1990, 2002, 1)) +
  scale_y_continuous(breaks = c(0, 1)) +
  labs(x = "\nAnnée",
       y = "Total thèse\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 0))

```

# Outliers

## Outliers director

### Import et préparation des données

```{r PhD outliers import prépartion données, message = FALSE, warning = FALSE}

these_director <- these[!grepl(",", these$`Directeur de these (nom prenom)`), ]
these_director <- these_director[!grepl("@", these_director$`Directeur de these (nom prenom)`), ]

these_director <- these_director %>%
  filter(Year > 1983 & Year < 2019) %>% 
  select(`Directeur de these (nom prenom)`, `Identifiant directeur`) %>% 
  group_by(`Directeur de these (nom prenom)`) %>% 
  mutate(total_these_diriger = n())

dim(these_director)
n_distinct(these_director$`Directeur de these (nom prenom)`)
n_distinct(these_director$`Identifiant directeur`)

```

### Méthodes de différent moyen de calcul des outliers

```{r PhD outliers autres methodes, message = FALSE, warning = FALSE}

# Mean and Standard deviation (SD)
## Tmin, Tmax = mean(+-)(k*sd), k = 3
Tmin_msd <-  mean(these_director$total_these_diriger) - ( 3 * sd(these_director$total_these_diriger))
Tmax_msd <-  mean(these_director$total_these_diriger) + ( 3 * sd(these_director$total_these_diriger))
msd <- which(these_director$total_these_diriger < Tmin_msd | 
                                                  these_director$total_these_diriger > Tmax_msd)
msd_outliers <- these_director[msd,]
min(msd_outliers$total_these_diriger)
max(msd_outliers$total_these_diriger)

# Median and Median Absolute Deviation (MAD)
## MAD = b * median(|xi - median(x)|), b = 1.4826 for normal distribution
## Tmin, Tmax = median(+-)(k*MAD), k = 3
med <- median(these_director$total_these_diriger)
abs_med <- abs(these_director$total_these_diriger - med)
mad <- 1.4826 * median(abs_med)
Tmin_mad <- med - ( 3 * mad)
Tmax_mad <- med + ( 3 * mad)
mad <- which(these_director$total_these_diriger < Tmin_mad | 
               these_director$total_these_diriger > Tmax_mad)
mad_outliers <- these_director[mad,]
min(mad_outliers$total_these_diriger)
max(mad_outliers$total_these_diriger)

# Interquartile Range (IQR)
## Tmin = Q1 - (c * IQR) c = 1.5(mild)
## Tmax = Q3 + (c * IQR) c = 1.5(mild)
summary(these_director)
IQR(these_director$total_these_diriger)
Tmin_iqr_mild <- 4 - (1.5 * 14)
Tmax_iqr_mild <- 18 + (1.5 * 14)
iqr_mild <- which(these_director$total_these_diriger < Tmin_iqr_mild | 
               these_director$total_these_diriger > Tmax_iqr_mild)
iqr_mild_outliers <- these_director[iqr_mild,]
min(iqr_mild_outliers$total_these_diriger)
max(iqr_mild_outliers$total_these_diriger)

## Tmin = Q1 - (c * IQR) c = 3(extreme)
## Tmax = Q3 + (c * IQR) c = 3(extreme)
Tmin_iqr_ext <- 4 - (3 * 14)
Tmax_iqr_ext <- 18 + (3 * 14)
iqr_ext <- which(these_director$total_these_diriger < Tmin_iqr_ext | 
                    these_director$total_these_diriger > Tmax_iqr_ext)
iqr_ext_outliers <- these_director[iqr_ext,]
min(iqr_ext_outliers$total_these_diriger)
max(iqr_ext_outliers$total_these_diriger)

```

### Visualisation des données manquantes

```{r PhD outliers NA, message = FALSE, warning = FALSE, eval = FALSE}

these_director %>% vis_miss(warn_large_data = FALSE) +
  scale_y_continuous(labels = comma) +
  theme(axis.text.x =  element_text(angle = 90))

```

### Recherches des outliers

```{r PhD outliers recherche outliers, message = FALSE, warning = FALSE}

these_director %>% 
  ggplot(aes(total_these_diriger)) +
  geom_histogram(binwidth = 3, fill = "steelblue", color = "Black") +
  geom_vline(aes(xintercept = median(total_these_diriger)), color = "yellow3", size = 1) +
  scale_y_continuous(labels = comma) +
  labs(x = "\nNombre de thèses dirigées",
       y = "Total directeurs\n") +
  scale_x_continuous(breaks = seq(0, 800, 50)) +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 45))

these_director %>% 
  ggplot(aes(total_these_diriger)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "Black") +
  geom_vline(aes(xintercept = median(total_these_diriger)), color = "yellow3", size = 1) +
  scale_x_continuous(limits = c(0, 220), breaks = seq(0, 220, 10)) +
  scale_y_continuous(labels = comma) +
  labs(x = "\nNombre de thèses dirigées",
       y = "Total directeurs\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 45))

these_director %>% 
  ggplot(aes(total_these_diriger)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "Black") +
  geom_vline(aes(xintercept = min(iqr_mild_outliers$total_these_diriger)), color = "yellow3", size = 1) +
  scale_x_continuous(limits = c(0, 220), breaks = seq(0, 220, 10)) +
  scale_y_continuous(labels = comma) +
  labs(x = "\nNombre de thèses",
       y = "Total directeurs\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 45))

these_director %>% 
  filter(total_these_diriger >= 40) %>% 
  ggplot(aes(total_these_diriger)) +
  geom_histogram(binwidth = 5, fill = "steelblue", color = "Black") +
  scale_x_continuous(breaks = seq(40, 720, 30)) +
  scale_y_continuous(labels = comma) +
  labs(x = "\nNombre de thèses dirigées",
       y = "Total directeurs\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 45))

```

### Analyse des outliers

```{r PhD outliers analyse outliers, message = FALSE, warning = FALSE}

# Total theses >= 40 & <= 140
these_director_outliers <- these_director %>% filter(total_these_diriger >= 40 &
                                                       total_these_diriger <= 140) 
dim(these_director_outliers)
n_distinct(these_director_outliers$`Directeur de these (nom prenom)`)
n_distinct(these_director_outliers$`Identifiant directeur`)
glimpse(these_director_outliers)

vis_miss(these_director_outliers)

ggplot(these_director_outliers, aes(total_these_diriger)) +
  geom_histogram(binwidth = 2, fill = "steelblue", color = "Black") +
  geom_vline(aes(xintercept = median(total_these_diriger)), color = "yellow3", size = 1) +
  labs(x = "\nNombre de thèses dirigées",
       y = "Total directeurs\n") +
  scale_x_continuous(breaks = seq(40, 140, 10)) +
  scale_y_continuous(breaks = seq(0, 2600, 400)) +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 45))

# total theses >=140 & <= 240
these_director_outliers_middle <- these_director %>% filter(total_these_diriger >= 140 &
                                                              total_these_diriger <= 240) 
dim(these_director_outliers_middle)
n_distinct(these_director_outliers_middle$`Directeur de these (nom prenom)`)
n_distinct(these_director_outliers_middle$`Identifiant directeur`)
glimpse(these_director_outliers_middle)

vis_miss(these_director_outliers_middle)

ggplot(these_director_outliers_middle, aes(total_these_diriger)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "Black") +
  geom_vline(aes(xintercept = median(total_these_diriger)), color = "yellow3", size = 1) +
  labs(x = "\nNombre de thèses dirigées ",
       y = "Total directeurs\n") +
  scale_x_continuous(breaks = seq(170, 210, 10)) +
  scale_y_continuous(breaks = seq(0, 200, 20)) +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 45))

# Total theses > 700.
these_director_outliers_big <- these_director %>% filter(total_these_diriger > 250)  
dim(these_director_outliers_big)
n_distinct(these_director_outliers_big$`Directeur de these (nom prenom)`)
unique(these_director_outliers_big$`Directeur de these (nom prenom)`)
n_distinct(these_director_outliers_big$`Identifiant directeur`)
glimpse(these_director_outliers_big)

vis_miss(these_director_outliers_big)

```

# Résultats préliminaires

## Langues

### Import et préparation des données

```{r PhD résulats préliminaires import préparation données, message = FALSE, warning = FALSE}

these_langue <- these
these_langue <- rename(these_langue, Langue = `Langue de la these`)
these_langue <- these_langue %>% 
  mutate(Langue = as.factor(case_when(
    is.na(Langue) ~ "NA",
    Langue ==  "fr" ~ "Français",
    Langue == "en" ~ "Anglais",
    Langue == "enfr" | Langue == "fren" ~ "Bilingue",
    TRUE ~ "Autres")))
levels(these_langue$Langue)
summary(these_langue)

these_langue %>% 
  summarise(across(everything(), n_distinct)) %>% 
  glimpse()

```

### Données manquantes

```{r PhD résulats préliminaires données manquantes, message = FALSE, warning = FALSE}

vis_miss(these_langue, warn_large_data = FALSE)+
  scale_y_continuous(labels = comma) +
  theme(axis.text.x =  element_text(angle = 90))

```

### Exploration

```{r PhD résulats préliminaires exploration, message = FALSE, warning = FALSE}

# Fréquence des langues.
these_langue_count_year <- these_langue %>% 
  select(Year) %>% 
  count(Year) %>% 
  rename(total_year = n)

these_langue_count_langue <- these_langue %>%
  count(Year, Langue) %>% 
  rename(langue_count = n)

these_langue_fulljoin <- full_join(these_langue_count_year,
               these_langue_count_langue,
               by = "Year") %>% 
  mutate(freq = langue_count / total_year)

# Jeu de données entier
these_langue_fulljoin %>% 
ggplot(aes(Year, freq,  color = Langue)) +
  geom_line(size = 1) + 
  scale_x_continuous(breaks = seq(1970, 2020, 5)) +
  scale_y_continuous(labels = percent_format()) +
  labs(x = "\nAnnée",
       y = "Fréquences\n") +
  theme_stata() +
  theme(axis.text.y = element_text(angle = 0))

# Période de 2004 à 2018
these_langue_fulljoin %>% 
  filter(Year >= 2004 & Year <= 2018) %>% 
  ggplot(aes(Year, freq, color = Langue)) +
  geom_step(size = 1) + 
  scale_x_continuous(breaks = seq(2004, 2018, 1)) +
  scale_y_continuous(labels = percent_format()) +
  labs(x = "\nAnnée",
       y = "Fréquences\n") +
  theme_stata() +
  theme(axis.text.x =  element_text(angle = 45,
                                    vjust = 0.5),
        axis.text.y = element_text(angle = 0,
                                   hjust = 0.5))

```

# SQL

```{r PhD sql, message = FALSE, warning = FALSE}

business <- read_csv("jeux_de_donnees/business.csv")

glimpse(business)

```

# Travail en bonus

## Heatmap des données manquantes

### Import et préparation des données

```{r PhD travail bonus heatmap import preparation, message = FALSE, warning = FALSE}

these_missing_heatmap <- these %>% 
  select(Year, `Langue de la these`, `Identifiant etablissement`, `Identifiant directeur`,
         `Identifiant auteur`, `Date de soutenance`, `Date de premiere inscription en doctorat`, 
         Statut) %>% 
  group_by(Statut) %>% 
  miss_var_summary()
these_missing_heatmap$pct_miss <- round(these_missing_heatmap$pct_miss, 1)

```

### Visualisations

```{r PhD travail bonus heatmap visualisation, message = FALSE, warning = FALSE}

these_missing_heatmap %>% 
  ggplot(aes(Statut, variable, fill = pct_miss)) +
  geom_tile(color = "black") +
  geom_text(aes(label = pct_miss), color = "black", size = 4) +
  labs(y = "Variables\n") +
  scale_fill_gradient2(low = "#075AFF",
                       mid = "#FFFFCC",
                       high = "#FF0000") +
  guides(fill = guide_colourbar(barwidth = 0.5,
                                barheight = 20)) +
  coord_fixed()

gg_miss_fct(x = these, fct = Statut)

```

Les deux heatmap représente la même chose mais montre deux moyens de le faire diffèrement.\

## Problème Genre/Discipline/Langue

### Problème Genre/Discipline import et préparation des données PhD_v2_gender

```{r PhD travail bonus Genre_Discipline import preparation, message = FALSE, warning = FALSE}

these_gender <- as_tibble(read_csv("jeux_de_donnees/PhD_v2_gender.csv"))
these_gender <- subset(these_gender, select = -c(...1))
these_gender$`Date de premiere inscription en doctorat` <- dmy(these_gender$`Date de premiere inscription en doctorat`)
these_gender$`Date de soutenance` <- dmy(these_gender$`Date de soutenance`)
these_gender$`Publication dans theses.fr` <- dmy(these_gender$`Publication dans theses.fr`)
these_gender$`Mise a jour dans theses.fr` <- dmy(these_gender$`Mise a jour dans theses.fr`)
these_gender$Statut <- as.factor(these_gender$Statut)
these_gender$`Langue de la these` <- as.factor(these_gender$`Langue de la these`)
these_gender$`Accessible en ligne` <- as.factor(these_gender$`Accessible en ligne`)
these_gender$`Identifiant directeur` <- na_if(these_gender$`Identifiant directeur`,"na")
these_gender$gender <- as.factor(these_gender$gender)
these_gender$Gender <- these_gender$gender


these_gender %>% 
  subset(select = -c(gender)) %>% 
  summarise(across(everything(), n_distinct)) %>% 
  glimpse()

```

### Visualisations

```{r PhD travail bonus Genre_Discipline visualisation, message=FALSE, warning=FALSE}

# Selection des top 5 disciplines
these_gender_top_5_discipline <- these_gender %>% 
  select(Discipline, Gender) %>% 
  count(Discipline, sort = TRUE) %>% 
  slice(1:5) %>% 
  subset(select = -c(n)) %>% 
  pull()

these_gender_top_5_discipline <- these_gender %>% 
  filter(Discipline %in% these_gender_top_5_discipline)

# Visualisations
these_gender_top_5_discipline %>% 
  ggplot(aes(Gender, after_stat(count/sum(count)), fill = Discipline)) + 
  geom_bar( position = "dodge", color = "black") + 
  facet_wrap( ~ Discipline, scales = "free") +
  scale_y_continuous(labels = percent_format()) +
  labs(x = "Genre",
       y = "Fréquences\n") +
  theme_stata() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text.x = element_text(size = 10),
        axis.text.y = element_text(angle = 0))

these_gender_top_5_discipline %>% 
  ggplot(aes(Gender, after_stat(count/sum(count)), fill = Discipline, by = Gender)) + 
  geom_bar( position = "fill", color = "black") + 
  geom_text(stat = "prop", position = position_fill(.5), 
            colour = "white", fontface = "bold", size = 3.5) +
  scale_y_continuous(labels = percent_format()) +
  labs(x = "Genre",
       y = "Proportions\n") +
  theme_stata() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.3, 'cm'), 
        legend.key.height = unit(0.3, 'cm'), 
        legend.key.width = unit(0.3, 'cm'), 
        legend.title = element_text(size=14), 
        legend.text = element_text(size=10),
        axis.text.y = element_text(angle = 0))

these_gender_top_5_discipline %>% 
  ggplot(aes(Gender, after_stat(count/sum(count)), fill = Discipline)) + 
  geom_bar(position = "dodge", color = "black") + 
  scale_y_continuous(labels = percent_format()) +
  labs(x = "Genre",
       y = "Fréquences\n") +
  theme_stata() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.3, 'cm'), 
        legend.key.height = unit(0.3, 'cm'), 
        legend.key.width = unit(0.3, 'cm'), 
        legend.title = element_text(size=14), 
        legend.text = element_text(size=10),
        axis.text.y = element_text(angle = 0))

```

### Problème Genre/Discipline import et préparation des données PhD_v3

```{r PhD travail bonus Genre_Discipline import preparation v3, message = FALSE, warning = FALSE}

these_v3 <- as_tibble(read_csv("jeux_de_donnees/PhD_v3.csv"))
these_v3 <- subset(these_v3, select = -c(...1))
these_v3$`Date de premiere inscription en doctorat` <- dmy(these_v3$`Date de premiere inscription en doctorat`)
these_v3$`Date de soutenance` <- dmy(these_v3$`Date de soutenance`)
these_v3$`Publication dans theses.fr` <- dmy(these_v3$`Publication dans theses.fr`)
these_v3$`Mise a jour dans theses.fr` <- dmy(these_v3$`Mise a jour dans theses.fr`)
these_v3$Statut <- as.factor(these_v3$Statut)
these_v3$`Langue de la these` <- as.factor(these_v3$`Langue de la these`)
these_v3$`Accessible en ligne` <- as.factor(these_v3$`Accessible en ligne`)
these_v3$`Identifiant directeur` <- na_if(these_v3$`Identifiant directeur`,"na")
these_v3$Genre <- as.factor(these_v3$Genre)
these_v3 <- rename(these_v3, Discipline_prediction = `Discipline_prÃ©di`)
these_v3$Discipline_prediction <- as.factor(these_v3$Discipline_prediction)
levels(these_v3$Discipline_prediction)[levels(these_v3$Discipline_prediction) == "MathÃ©matiques"] <- "Mathematiques"
levels(these_v3$Discipline_prediction)[levels(these_v3$Discipline_prediction) == "Science de l'ingÃ©nieur" ] <- "Science de l'ingenieur" 


these_v3 %>% 
  summarise(across(everything(), n_distinct)) %>% 
  glimpse()

```

### Préparation des tables intermédiaires

```{r PhD travail bonus Genre_Discipline tables intermediaires v3, message = FALSE, warning = FALSE}

these_v3_count_year <- these_v3 %>% 
  filter(Year >= 1985 & Year <= 2018) %>%  
  count(Year) %>% 
  rename(total_year = n)

these_v3_year_genre_discipline <-  these_v3  %>% 
  filter(Year >= 1985 & Year <= 2018) %>% 
  count(Year, Genre, Discipline_prediction) %>% 
  rename(total = n)

these_genre_discipline_full <- full_join(these_v3_count_year, 
                                         these_v3_year_genre_discipline, 
                                         by = "Year") %>% 
  mutate(freq = total / total_year) %>% 
  drop_na()

```

### Visualisation

```{r PhD travail bonus Genre_Discipline visualisation v3, message = FALSE, warning = FALSE}

these_genre_discipline_full %>% 
  ggplot(aes(Year, freq, fill = Discipline_prediction)) +
  geom_area(color = "black") +
  facet_wrap( ~ Genre, scales = "free_y") +
  scale_x_continuous(breaks = seq(1985, 2020, 5)) +
  scale_y_continuous(labels = percent_format()) +
  labs(x = "\nAnnée",
       y = "Proportions\n")  +
  theme_stata() +
  theme(axis.text.x =  element_text(angle = 45,
                                    vjust = 0.5),
        axis.text.y = element_text(angle = 0,
                                   hjust = 0.5),
        legend.key.size = unit(0.2, "cm"),
        legend.text = element_text(size = '8'),
        legend.title = element_blank())

```

### Problème Langue/Discipline import et préparation des données PhD_v3

```{r PhD travail bonus Langue_Discipline import preparation v3, message = FALSE, warning = FALSE}

these_v3_langue <- these_v3
these_v3_langue <- rename(these_v3_langue, Langue = `Langue de la these`)
these_v3_langue <- these_v3_langue %>% 
  mutate(Langue = as.factor(case_when(
    is.na(Langue) ~ "NA",
    Langue ==  "fr" ~ "Français",
    Langue == "en" ~ "Anglais",
    Langue == "enfr" | Langue == "fren" ~ "Bilingue",
    TRUE ~ "Autres")))

```

### Préparation des tables intermédiaires

```{r PhD travail bonus Langue_Discipline tables intermediaires v3, message = FALSE, warning = FALSE}

these_soutenance_year_langue_discipline <-  these_v3_langue  %>% 
  filter(Year >= 1985 & Year <= 2018) %>% 
  count(Year, Langue, Discipline_prediction) %>% 
  rename(total = n)

these_genre_discipline_full <- full_join(these_v3_count_year, 
                                         these_soutenance_year_langue_discipline, 
                                         by = "Year") %>% 
  mutate(freq = total / total_year)

```

### Visualisation

```{r PhD travail bonus Langue_Discipline visualisation v3, message = FALSE, warning = FALSE}

these_genre_discipline_full %>% 
  ggplot(aes(Year, freq, fill = Discipline_prediction)) +
  geom_area(color = "black", alpha = 0.7) +
  facet_wrap( ~ Langue , scales = "free_y") +
  scale_x_continuous(breaks = seq(1985, 2020, 5)) +
  scale_y_continuous(labels = percent_format()) +
  labs(x = "Année",
       y = "Proportions\n") +
  theme_stata() +
  theme(axis.text.x =  element_text(angle = 45,
                                    vjust = 0.5),
        axis.text.y = element_text(angle = 0,
                                   hjust = 0.5),
        legend.key.size = unit(0.2, "cm"),
        legend.text = element_text(size = '8'),
        legend.title = element_blank())


```

## Webscraping

```{r PhD travail bonus Web scraping, message = FALSE, warning = FALSE}

######################### Déclaration des séquences ################################################
langue <- c("fr", "en", "es")
numero_page <- seq(0, 500, 10)
numero_page_langue <- seq(0, 300, 10)

######################### Déclaration des tibbles ################################################
thesis_webscraping_info <- tibble()
thesis_webscraping_pdf <- tibble()
thesis_webscraping_langue <- tibble()

######################### Scrap des informations ################################################
for (page_result in numero_page) {
  link_infos <- paste0("https://theses.fr/fr/?q=&fq=dateSoutenance:[1965-01-01T23:59:59Z%2BTO%2B2022-12-31T23:59:59Z]&checkedfacets=&start=", 
                 page_result,"&sort=none&status=&access=&prevision=&filtrepersonne=&zone1=titreRAs&val1=&op1=AND&zone2=auteurs&val2=&op2=AND&zone3=etabSoutenances&val3=&op3=AND&zone4=dateSoutenance&val4a=&val4b=&type=")  
  pages_infos <- read_html(link_infos)
  
  Titre <- pages_infos %>% html_nodes("h2 a") %>% html_text2() %>% str_to_lower() %>% 
    str_to_sentence()
  
  Auteur <- pages_infos %>% html_nodes("#resultat p") %>% html_text2() %>% 
    str_split("\\r", n = 2) %>% map_chr(1) %>% sub(".*? ", "", .)
  
  Discipline <- pages_infos %>% html_nodes(".domaine h5:nth-child(1)") %>% html_text2()
  
  Directeur <- pages_infos %>% html_nodes("#resultat p") %>% html_text2() %>% 
    str_split("\\r", n = 3) %>% 
    map_chr(3) %>% sub(".*? ", "", .) %>% str_replace(" et de \r", ",") %>% 
    str_split("\\r") %>% map_chr(1)
  
  Etablissment <- pages_infos %>% html_nodes("#resultat p") %>% html_text2() %>% 
    str_split("\\r", n = 3) %>% 
    map_chr(3) %>% sub(".*? ", "", .) %>% str_replace(" et de \r", ",") %>% 
    str_split("\\r") %>% map_chr(2) %>% str_remove(" - ")
  
  Statut <- pages_infos %>% html_nodes("div.statusThese img") %>% html_attr("title")
  
  Date_soutenance_ymd <- pages_infos %>% html_nodes("br+ h5") %>% html_text2() %>% 
    str_remove("En préparation depuis le ") %>% str_sub(13, 22) %>% dmy()
  
  Date_soutenance_y <-  pages_infos %>% html_nodes("br+ h5") %>% html_text2() %>% 
    str_remove_all("En préparation depuis le ") %>% str_remove_all("Soutenue le ") %>% 
    str_sub(12, 16) %>% as.Date(as.character(), format = "%Y") %>% year()
  
  Date_inscription <- pages_infos %>% html_nodes("br+ h5") %>% html_text2() %>% 
    str_sub(25, 35) %>% dmy()
  
  
  thesis_webscraping_info <- rbind(thesis_webscraping_info, tibble(Auteur, Titre, Discipline, Directeur, 
                                           Etablissment, Statut, Date_inscription,
                                           Date_soutenance_ymd, Date_soutenance_y))
  
}

######################### Scrap des pdf ################################################
for (page_pdf in numero_page) {
  link_pdf <- paste0("https://theses.fr/fr/?q=&fq=dateSoutenance:[1965-01-01T23:59:59Z%2BTO%2B2022-12-31T23:59:59Z]&checkedfacets=&start=",page_pdf,"&sort=none&status=&access=accessible:oui&prevision=&filtrepersonne=&zone1=titreRAs&val1=&op1=AND&zone2=auteurs&val2=&op2=AND&zone3=etabSoutenances&val3=&op3=AND&zone4=dateSoutenance&val4a=&val4b=&type=")
  pages_pdf <- read_html(link_pdf)
  
  Link_to_pdf <- pages_pdf %>% html_nodes(".arrondi-10x a") %>% html_attr("href") %>% 
    paste0("theses.fr", .)
  
  Auteur <- pages_pdf %>% html_nodes("#resultat p") %>% html_text2() %>% 
    str_split("\\r", n = 2) %>% map_chr(1) %>% sub(".*? ", "", .)
  
  thesis_webscraping_pdf <- rbind(thesis_webscraping_pdf, tibble(Auteur, Link_to_pdf))
  
}


######################### Scrap des langues (Pbm duplicate later) ################################################
for(Lg in langue){
  for (npl in numero_page_langue) {
    link_langue <- paste0("https://theses.fr/fr/?q=&fq=dateSoutenance:[1965-01-01T23:59:59Z%2BTO%2B2022-12-31T23:59:59Z]&checkedfacets=langueThese=",Lg,";&start=",npl,"&status=&access=&prevision=&filtrepersonne=&zone1=titreRAs&val1=&op1=AND&zone2=auteurs&val2=&op2=AND&zone3=etabSoutenances&val3=&op3=AND&zone4=dateSoutenance&val4a=&val4b=&type=")
    pages_langue <- read_html(link_langue)
    
    Auteur <- pages_langue %>% html_nodes("#resultat p") %>% html_text2() %>% 
      str_split("\\r", n = 2) %>% map_chr(1) %>% sub(".*? ", "", .)
    
    Langue <- Lg
    
    thesis_webscraping_langue <- rbind(thesis_webscraping_langue, tibble(Auteur, Langue))

  }
}

######################### Fusion des tibbles ################################################
thesis_webscraping <- left_join(thesis_webscraping_info, thesis_webscraping_pdf, by = "Auteur")
thesis_webscraping <- left_join(thesis_webscraping, thesis_webscraping_langue, by = "Auteur")


######################### Data wrangling ################################################
thesis_webscraping <- thesis_webscraping %>% mutate(Statut = case_when(Statut == " thèse en cours de préparation" ~ "en_cours", Statut == "thèse soutenue" ~ "soutenue"))


glimpse(thesis_webscraping)
summary(thesis_webscraping)
head(thesis_webscraping)

```
